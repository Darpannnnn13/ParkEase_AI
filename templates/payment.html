{% extends "base.html" %}
{% block title %}Secure Payment - ParkEase{% endblock %}
{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 animate-slide-up">
    <div class="max-w-md w-full space-y-8 glass p-8 rounded-2xl shadow-2xl">
        <!-- Header -->
        <div class="text-center">
            <a href="{{ url_for('user_dashboard') }}" class="inline-flex items-center text-sm text-gray-500 hover:text-primary mb-4 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </a>
            <div class="mx-auto h-16 w-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-shield-alt text-3xl text-green-600"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900">Secure Payment</h2>
            <p class="mt-2 text-sm text-gray-600">Complete your booking for <br><span class="font-bold text-gray-800">{{ booking.area_name }}</span></p>
        </div>

        <!-- Amount Display -->
        <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex justify-between items-center shadow-inner">
            <span class="text-gray-700 font-medium">Total Amount</span>
            <span class="text-2xl font-bold text-primary" id="display-amount">₹{{ "%.2f"|format(booking.amount) }}</span>
        </div>

        <!-- Coupon Section -->
        <div class="mt-4 relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Have a Coupon?</label>
            <div class="flex space-x-2">
                <input type="text" id="coupon-code" placeholder="Enter code" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary uppercase">
                <button type="button" onclick="applyCoupon()" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition text-sm font-bold">Apply</button>
            </div>
            
            <button type="button" onclick="toggleCouponList()" class="text-xs text-primary hover:text-indigo-700 mt-2 font-bold flex items-center transition-colors focus:outline-none">
                <i class="fas fa-tags mr-1"></i> View Available Coupons
            </button>

            <div id="coupon-list" class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-xl shadow-xl mt-2 max-h-48 overflow-y-auto animate-slide-up">
                <div class="p-2 bg-gray-50 border-b border-gray-100 text-xs font-bold text-gray-500 uppercase">Select a coupon</div>
                {% for code, details in coupons.items() %}
                <div onclick="selectCoupon('{{ code }}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 last:border-0 flex justify-between items-center group transition-colors">
                    <div>
                        <span class="font-bold text-gray-800 group-hover:text-primary block">{{ code }}</span>
                        <span class="text-xs text-gray-500">
                            {% if details.type == 'percent' %}
                                {{ details.value }}% Discount
                            {% else %}
                                Flat ₹{{ details.value }} OFF
                            {% endif %}
                        </span>
                    </div>
                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded group-hover:bg-white group-hover:text-primary transition-colors">Apply</span>
                </div>
                {% else %}
                <div class="p-4 text-center text-sm text-gray-500">No coupons available.</div>
                {% endfor %}
            </div>

            <p id="coupon-message" class="text-xs mt-1 hidden"></p>
        </div>

        <!-- Wallet Payment Option -->
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mt-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-medium flex items-center"><i class="fas fa-wallet mr-2 text-secondary"></i>Wallet Balance</span>
                <span class="font-bold text-gray-800" id="wallet-balance" data-balance="{{ current_user.wallet_balance }}">₹{{ "%.2f"|format(current_user.wallet_balance) }}</span>
            </div>
            
            <button id="pay-wallet-btn" class="w-full bg-gray-800 text-white font-bold py-2 rounded-lg hover:bg-gray-900 transition shadow-md {% if current_user.wallet_balance < booking.amount %}hidden{% endif %}">
                Pay with Wallet
            </button>
            <p id="wallet-insufficient-msg" class="text-xs text-red-500 text-center mt-1 {% if current_user.wallet_balance >= booking.amount %}hidden{% endif %}">Insufficient balance. <a href="{{ url_for('wallet') }}" target="_blank" class="text-indigo-600 hover:underline font-bold">Add money</a> or use card below.</p>
        </div>

        <!-- Stripe Payment Form -->
        <form id="payment-form" class="mt-8 space-y-6">
            <div id="payment-element" class="min-h-[200px]">
                <!-- Stripe Elements will be inserted here -->
                <div class="flex justify-center items-center h-full text-gray-500">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading secure gateway...
                </div>
            </div>
            <div id="error-message" class="text-red-500 text-sm text-center hidden"></div>
            
            <div class="pt-4">
                <button type="submit" id="pay-btn" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-xl text-white bg-gradient-to-r from-primary to-indigo-600 hover:shadow-lg transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <i class="fas fa-lock text-indigo-300 group-hover:text-indigo-100"></i>
                    </span>
                    Pay Now
                </button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-4 flex justify-center items-center gap-2">
                <i class="fab fa-stripe text-3xl text-indigo-600"></i>
                <span>Secured by Stripe</span>
            </p>
        </form>
    </div>
</div>
<script src="https://js.stripe.com/v3/"></script>
<script>
    let currentCoupon = null;
    let currentAmount = {{ booking.amount }};
    let stripe, elements;

    function toggleCouponList() {
        const list = document.getElementById('coupon-list');
        list.classList.toggle('hidden');
    }

    function selectCoupon(code) {
        document.getElementById('coupon-code').value = code;
        document.getElementById('coupon-list').classList.add('hidden');
        applyCoupon();
    }

    async function applyCoupon() {
        const code = document.getElementById('coupon-code').value.trim();
        const msgEl = document.getElementById('coupon-message');
        
        if (!code) return;

        const res = await fetch('/api/validate_coupon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, booking_id: "{{ booking._id }}" })
        });
        const data = await res.json();

        msgEl.classList.remove('hidden', 'text-green-600', 'text-red-500');
        if (data.valid) {
            currentCoupon = code;
            currentAmount = data.new_total;
            document.getElementById('display-amount').innerText = `₹${data.new_total.toFixed(2)}`;
            msgEl.innerText = data.message;
            msgEl.classList.add('text-green-600');
            
            // Update Wallet Button Visibility
            const balance = parseFloat(document.getElementById('wallet-balance').getAttribute('data-balance'));
            if (balance >= currentAmount) {
                document.getElementById('pay-wallet-btn').classList.remove('hidden');
                document.getElementById('wallet-insufficient-msg').classList.add('hidden');
            } else {
                document.getElementById('pay-wallet-btn').classList.add('hidden');
                document.getElementById('wallet-insufficient-msg').classList.remove('hidden');
            }

            // Re-initialize Stripe with new amount
            await setupStripe();
        } else {
            msgEl.innerText = data.message;
            msgEl.classList.add('text-red-500');
        }
    }

    async function setupStripe() {
        const bookingId = "{{ booking._id }}";
        const container = document.getElementById('payment-element');
        
        // Show loading state while reloading
        container.innerHTML = '<div class="flex justify-center items-center h-full text-gray-500"><i class="fas fa-circle-notch fa-spin mr-2"></i> Updating secure gateway...</div>';
        
        try {
            // Fetch PaymentIntent
            const response = await fetch(`/create-payment-intent/${bookingId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ coupon_code: currentCoupon }) 
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            stripe = Stripe(data.publicKey);
            elements = stripe.elements({ clientSecret: data.clientSecret, appearance: { theme: 'stripe' } });
            const paymentElement = elements.create('payment');
            
            // Clear container and mount
            container.innerHTML = '';
            paymentElement.mount('#payment-element');
            
        } catch (err) {
            console.error(err);
            container.innerHTML = `<div class="text-red-500 text-center p-4 bg-red-50 rounded-lg border border-red-200"><p class="font-bold">Unable to load payment gateway.</p><p class="text-sm">${err.message || "Server error"}</p></div>`;
            document.getElementById('pay-btn').disabled = true;
            document.getElementById('pay-btn').classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await setupStripe();

        // Stripe Form Handler
        const form = document.getElementById('payment-form');
        const btn = document.getElementById('pay-btn');
        const errorMsg = document.getElementById('error-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Processing...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            errorMsg.classList.add('hidden');
        
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: "{{ url_for('process_payment', booking_id=booking._id, _external=True) }}",
                },
                redirect: "if_required"
            });

            if (error) {
                errorMsg.textContent = error.message;
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = 'Pay Now';
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            } else {
                // Payment succeeded, notify backend
                await fetch(`{{ url_for('process_payment', booking_id=booking._id) }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                window.location.href = "{{ url_for('user_dashboard') }}";
            }
        });

        // Wallet Payment Handler
        const walletBtn = document.getElementById('pay-wallet-btn');
        if (walletBtn) {
            walletBtn.addEventListener('click', async () => {
                if(!confirm(`Pay ₹${currentAmount.toFixed(2)} from your wallet?`)) return;
                
                walletBtn.disabled = true;
                walletBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Processing...';

                const res = await fetch(`{{ url_for('process_payment', booking_id=booking._id) }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method: 'wallet', coupon_code: currentCoupon })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.error || "Payment failed");
                    walletBtn.disabled = false;
                    walletBtn.innerHTML = 'Pay with Wallet';
                }
            });
        }
    });
</script>
{% endblock %}