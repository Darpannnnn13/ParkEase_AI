{% extends "base.html" %}

{% block title %}Live Availability - ParkEase{% endblock %}

{% block content %}
<div class="animate-slide-up">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 glass p-4 sm:p-6 rounded-2xl shadow-2xl border border-white/40 flex flex-col">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center flex-shrink-0"><i class="fas fa-list-ul mr-3 text-primary"></i>Parking Areas</h2>
            
            <div class="mb-4 space-y-3 flex-shrink-0">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search location or venue..." class="w-full px-4 py-2 pl-10 bg-white/50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <div class="flex flex-wrap gap-2">
                    <label class="flex items-center space-x-2 bg-white/50 px-3 py-1 rounded-lg border border-gray-200 cursor-pointer hover:bg-white transition">
                        <input type="checkbox" id="filter-ev" class="rounded text-primary focus:ring-primary"> <span class="text-sm font-medium text-gray-700"><i class="fas fa-bolt text-yellow-500 mr-1"></i>EV</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-white/50 px-3 py-1 rounded-lg border border-gray-200 cursor-pointer hover:bg-white transition">
                        <input type="checkbox" id="filter-handicap" class="rounded text-primary focus:ring-primary"> <span class="text-sm font-medium text-gray-700"><i class="fas fa-wheelchair text-blue-500 mr-1"></i>Accessible</span>
                    </label>
                </div>
            </div>

            <div id="availability-list" class="space-y-4 transition-all duration-300 overflow-y-auto pr-2 h-96 lg:h-[500px]">
                <p class="text-gray-500">Fetching availability...</p>
                {% if not areas %}
                <div class="text-center py-4">
                    <p class="text-sm text-gray-600 mb-2">No areas found.</p>
                    <a href="{{ url_for('seed_db') }}" class="text-xs bg-primary text-white px-3 py-2 rounded hover:bg-indigo-700 transition">Initialize System Data</a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="lg:col-span-2 glass p-4 sm:p-6 rounded-2xl shadow-2xl border border-white/40">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center"><i class="fas fa-map-marked-alt mr-3 text-primary"></i>Live Map</h2>
            <div class="w-full h-96 lg:h-[500px] rounded-xl overflow-hidden shadow-inner border border-gray-200 relative z-0">
                 <div id="map" class="w-full h-full"></div>
            </div>
        </div>

    </div>

    {% if not current_user.is_authenticated or not current_user.is_admin %}
    <div class="mt-8 glass p-4 sm:p-8 rounded-2xl shadow-2xl border border-white/40 transform hover:-translate-y-1 transition-all duration-300">
        <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600">Find & Book a Spot</h2>
        <form action="{{ url_for('book_spot') }}" method="POST" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end">
            <input type="hidden" name="slot_id" id="selected-slot-id">
            <div class="w-full md:w-1/3">
                <label class="block text-gray-700 text-sm font-bold mb-2"><i class="fas fa-map-pin mr-2 text-primary"></i>Select Area</label>
                <select name="area_id" id="booking-area-select" class="w-full px-4 py-3 bg-white/50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm">
                    {% for area in areas %}
                    <option value="{{ area._id }}">{{ area.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-full md:w-1/4">
                <label class="block text-gray-700 text-sm font-bold mb-2"><i class="fas fa-clock mr-2 text-primary"></i>Arrival Time</label>
                <input type="datetime-local" name="booking_time" id="booking-time-input" class="w-full px-4 py-3 bg-white/50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm" required>
            </div>
            <div class="w-full md:w-1/6">
                <label class="block text-gray-700 text-sm font-bold mb-2"><i class="fas fa-hourglass-half mr-2 text-primary"></i>Duration</label>
                <select name="duration" id="booking-duration-select" class="w-full px-4 py-3 bg-white/50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="1">1 Hr</option>
                    <option value="2">2 Hrs</option>
                    <option value="3">3 Hrs</option>
                    <option value="4">4 Hrs</option>
                    <option value="5">5+ Hrs</option>
                </select>
            </div>
            <div class="w-full md:w-1/6">
                <label class="block text-gray-700 text-sm font-bold mb-2"><i class="fas fa-car-side mr-2 text-primary"></i>Vehicles</label>
                <input type="number" name="spots" id="booking-spots-input" value="1" min="1" max="5" class="w-full px-4 py-3 bg-white/50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary" readonly>
            </div>
            <div class="w-full md:w-1/3">
                <label class="block text-gray-700 text-sm font-bold mb-2"><i class="fas fa-id-card mr-2 text-primary"></i>Vehicle Number</label>
                {% if current_user.vehicle_number and current_user.vehicle_number != 'Not Set' %}
                    <input type="text" value="{{ current_user.vehicle_number }}" class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-xl text-gray-600 cursor-not-allowed" readonly>
                {% else %}
                    <a href="{{ url_for('profile') }}" class="block w-full px-4 py-3 bg-red-50 border border-red-300 rounded-xl text-red-600 hover:bg-red-100 text-center font-medium transition"><i class="fas fa-exclamation-circle mr-2"></i>Add Vehicle Number in Profile</a>
                {% endif %}
            </div>
            <button type="submit" {% if not current_user.vehicle_number or current_user.vehicle_number == 'Not Set' %}disabled{% endif %} class="flex items-center justify-center whitespace-nowrap bg-gradient-to-r from-primary to-indigo-600 text-white font-bold px-8 py-3 rounded-xl shadow-lg hover:shadow-xl hover:shadow-indigo-500/50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 w-full md:w-auto h-[50px] transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-check-circle mr-2"></i>Book
            </button>
        </form>
        <div id="selected-slot-display" class="mt-2 text-sm font-bold text-primary hidden">Selected Slots: <span id="slot-name"></span></div>
    </div>
    {% endif %}

    <div id="slot-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeSlotModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">Select Parking Slots</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 mb-4">Click to select. <span class="font-bold text-primary">Selected slots are locked for 5 minutes.</span></p>
                                <div class="flex space-x-2 mb-4 border-b border-gray-200" id="level-tabs">
                                    </div>
                                <div id="slots-grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3 max-h-96 min-h-[200px] overflow-y-auto p-2">
                                    <div class="col-span-full text-center text-gray-500">Loading slots...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" onclick="confirmSlotSelection()">Confirm Selection</button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeSlotModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const availabilityList = document.getElementById('availability-list');
        const searchInput = document.getElementById('search-input');
        const filterEv = document.getElementById('filter-ev');
        const filterHandicap = document.getElementById('filter-handicap');
        
        // Set default datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('booking-time-input').value = now.toISOString().slice(0,16);
        
        let allAreas = []; // Store fetched data
        let userLat = null;
        let userLng = null;
        let searchLocation = null; // Store geocoded search result

        // Initialize Leaflet map
        const map = L.map('map').setView([19.0760, 72.8777], 12); // Centered on Mumbai

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);

        // Function to render list
        function renderList(data) {
            availabilityList.innerHTML = ''; 
            markersLayer.clearLayers();
            const markers = [];
            
            const searchTerm = searchInput.value.toLowerCase();
            const showEv = filterEv.checked;
            const showHandicap = filterHandicap.checked;

            let filteredData = data.filter(area => {
                const matchesSearch = area.name.toLowerCase().includes(searchTerm);
                const matchesEv = showEv ? area.has_ev : true;
                const matchesHandicap = showHandicap ? area.has_handicap : true;
                return matchesSearch && matchesEv && matchesHandicap;
            });

            // Sort by distance: Priority to Search Location, then User Location
            if (searchLocation) {
                filteredData.forEach(area => {
                    if (area.location && area.location.coordinates) {
                        area.distance = getDistanceFromLatLonInKm(searchLocation.lat, searchLocation.lng, area.location.coordinates[1], area.location.coordinates[0]);
                    }
                });
                filteredData.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            } else if (userLat && userLng) {
                filteredData.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            }

            // Show only closest 4 when searching (either by name or location)
            if (searchTerm !== '' || searchLocation) {
                filteredData = filteredData.slice(0, 4);
            }
            
                filteredData.forEach(area => {
                    const percentage = (area.occupied / area.capacity) * 100;
                    let colorClass, availabilityText, markerColor;

                    if (percentage >= 95) {
                        colorClass = 'bg-red-500'; availabilityText = 'Full'; markerColor = '#ef4444'; // Red
                    } else if (percentage > 60) {
                        colorClass = 'bg-yellow-500'; availabilityText = 'Limited'; markerColor = '#f59e0b'; // Yellow
                    } else {
                        colorClass = 'bg-green-500'; availabilityText = 'Available'; markerColor = '#22c55e'; // Green
                    }

                    const distanceBadge = area.distance 
                        ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800"><i class="fas fa-location-arrow mr-1"></i>${area.distance.toFixed(1)} km</span>` 
                        : '';

                    // Update sidebar list
                    const areaElement = `
                        <div id="area-${area._id}" onclick="openSlotMap('${area._id}', '${area.name}')" class="bg-white/60 p-4 rounded-xl hover:shadow-lg hover:bg-white transition-all duration-300 border border-transparent hover:border-primary/20 cursor-pointer group relative overflow-hidden">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-lg text-gray-800 group-hover:text-primary transition-colors flex items-center">${area.name} ${distanceBadge}</h3>
                                <span class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600">${area.occupied} / ${area.capacity}</span>
                            </div>
                            <div class="flex space-x-2 mt-1 text-xs text-gray-500">
                                <span><i class="fas fa-tag mr-1"></i>₹${area.price || 20}/hr</span>
                                ${area.has_ev ? '<span class="text-yellow-600"><i class="fas fa-bolt"></i> EV</span>' : ''}
                                ${area.has_handicap ? '<span class="text-blue-600"><i class="fas fa-wheelchair"></i></span>' : ''}
                                ${area.has_bike ? '<span class="text-gray-600"><i class="fas fa-motorcycle"></i></span>' : ''}
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-3 overflow-hidden">
                                <div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="text-right text-sm mt-1 font-medium ${availabilityText === 'Full' ? 'text-red-600' : 'text-gray-600'}">${availabilityText}</div>
                        </div>
                    `;
                    availabilityList.insertAdjacentHTML('beforeend', areaElement);

                    // Add marker to map
                     const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="marker-pin" style="background-color: ${markerColor};"></div><i class="fas fa-parking text-white text-xs"></i>`,
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    });
                    
                    const marker = L.marker([area.location.coordinates[1], area.location.coordinates[0]], {icon: icon})
                                    .addTo(markersLayer)
                                    .bindPopup(`
                                        <div class="text-center">
                                            <b class="text-primary text-lg">${area.name}</b><br>
                                            <span class="text-gray-600">Occupied: ${area.occupied}/${area.capacity}</span><br>
                                            <span class="text-gray-800 font-bold">₹${area.price || 20}/hr</span><br>
                                            <a href="https://www.google.com/maps/dir/?api=1&destination=${area.location.coordinates[1]},${area.location.coordinates[0]}" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 block">Get Directions <i class="fas fa-external-link-alt"></i></a>
                                            <button onclick="openSlotMap('${area._id}', '${area.name}')" class="mt-2 w-full bg-primary text-white text-xs py-1 rounded hover:bg-indigo-700">View Slots</button>
                                        </div>
                                    `);
                    markers.push(marker);
                });
        }

        // Debounce function for API calls
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Geocoding Search (Nominatim)
        const performGeocodeSearch = debounce(async (query) => {
            if (!query || query.length < 3) return;
            
            try {
                // Search specifically within Mumbai/India bounds or generally
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Mumbai')}&limit=1`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    searchLocation = { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon) };
                    renderList(allAreas); // Re-render with new distance sorting
                }
            } catch (e) {
                console.error("Geocoding error:", e);
            }
        }, 800); // 800ms delay

        // Event Listeners for Filters
        searchInput.addEventListener('input', (e) => {
            searchLocation = null; // Reset previous geocode on new input
            renderList(allAreas); // Immediate local filter
            performGeocodeSearch(e.target.value); // Trigger remote search
        });
        filterEv.addEventListener('change', () => renderList(allAreas));
        filterHandicap.addEventListener('change', () => renderList(allAreas));

        // Initial Fetch
        fetch('/api/availability')
            .then(response => response.json())
            .then(data => {
                allAreas = data;
                
                // Get User Location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        
                        // Calculate distances
                        allAreas.forEach(area => {
                            if (area.location && area.location.coordinates) {
                                area.distance = getDistanceFromLatLonInKm(userLat, userLng, area.location.coordinates[1], area.location.coordinates[0]);
                            }
                        });
                        
                        renderList(allAreas);
                    }, () => {
                        renderList(allAreas); // Fallback if denied
                    });
                } else {
                    renderList(allAreas);
                }
            })
            .catch(error => {
                console.error('Error fetching parking availability:', error);
                availabilityList.innerHTML = '<p class="text-red-500">Could not load availability data.</p>';
            });

        // Module 4: Real-Time Socket Listener
        socket.on('update_availability', function(msg) {
            fetch('/api/availability').then(res => res.json()).then(data => { allAreas = data; renderList(data); });
        });

        // Distance Calculation Helper
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }
    });

    // Slot Map Logic
    let currentSlots = [];
    let selectedSlots = new Set();
    let currentAreaId = null;
    let currentAreaLevel = 1; 
    
    function openSlotMap(areaId, areaName) {
        document.getElementById('modal-title').innerText = `Select Slots: ${areaName}`;
        document.getElementById('slot-modal').classList.remove('hidden');
        
        // Sync booking form area
        currentAreaId = areaId;
        const areaSelect = document.getElementById('booking-area-select');
        if(areaSelect) areaSelect.value = areaId;

        const time = document.getElementById('booking-time-input').value;
        const duration = document.getElementById('booking-duration-select').value;
        
        // Reset selection on open
        selectedSlots.clear();

        fetch(`/api/area/${areaId}/slots?start_time=${time}&duration=${duration}`)
            .then(res => res.json())
            .then(data => {
                currentSlots = data;
                renderLevelTabs(data);
            })
            .catch(err => console.error(err));
    }

    function closeSlotModal() {
        // Optional: Unlock slots if user cancels? 
        // For better UX, we can unlock all selected slots when closing without confirming.
        if (selectedSlots.size > 0) {
            selectedSlots.forEach(slotNum => {
                fetch('/api/unlock_slot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ area_id: currentAreaId, slot_number: slotNum })
                });
            });
        }
        document.getElementById('slot-modal').classList.add('hidden');
    }
    
    function confirmSlotSelection() {
        if (selectedSlots.size > 0) {
            const slotsArray = Array.from(selectedSlots);
            document.getElementById('selected-slot-id').value = slotsArray.join(',');
            document.getElementById('slot-name').innerText = slotsArray.join(', ');
            document.getElementById('selected-slot-display').classList.remove('hidden');
            document.getElementById('booking-spots-input').value = selectedSlots.size;
        } else {
            document.getElementById('selected-slot-id').value = "";
            document.getElementById('selected-slot-display').classList.add('hidden');
            document.getElementById('booking-spots-input').value = 1;
        }
        // Just hide modal, don't trigger the closeSlotModal cleanup logic
        document.getElementById('slot-modal').classList.add('hidden');
    }

    function renderLevelTabs(slots) {
        const levels = [...new Set(slots.map(s => s.level))].sort();
        const tabsContainer = document.getElementById('level-tabs');
        tabsContainer.innerHTML = '';
        
        // Only show tabs if there is more than one level
        if (levels.length > 1) {
            tabsContainer.style.display = 'flex';
            levels.forEach((lvl, index) => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 text-sm font-medium focus:outline-none ${index === 0 ? 'text-primary border-b-2 border-primary' : 'text-gray-500 hover:text-gray-700'}`;
                btn.innerText = `Level ${lvl}`;
                btn.onclick = () => {
                    Array.from(tabsContainer.children).forEach(c => c.className = 'px-4 py-2 text-sm font-medium focus:outline-none text-gray-500 hover:text-gray-700');
                    btn.className = 'px-4 py-2 text-sm font-medium focus:outline-none text-primary border-b-2 border-primary';
                    currentAreaLevel = lvl;
                    renderSlots(lvl);
                };
                tabsContainer.appendChild(btn);
            });
        } else {
            tabsContainer.style.display = 'none';
        }

        if (levels.length > 0) {
            currentAreaLevel = levels[0];
            renderSlots(levels[0]);
        } else {
            document.getElementById('slots-grid').innerHTML = '<div class="col-span-full text-center text-gray-500">No slots found for this area.</div>';
        }
    }

    function renderSlots(level) {
        const grid = document.getElementById('slots-grid');
        grid.innerHTML = '';
        
        const levelSlots = currentSlots.filter(s => s.level === level);
        
        if (levelSlots.length === 0) {
            grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No slots found for this level.</div>';
            return;
        }

        levelSlots.forEach(slot => {
            const div = document.createElement('div');
            const isOccupied = slot.status === 'Occupied' || slot.status === 'Locked';
            const isSelected = selectedSlots.has(slot.slot_number) || slot.status === 'Selected';
            
            if (slot.status === 'Selected') selectedSlots.add(slot.slot_number);

            // Apply visual classes based on state
            let bgClass = 'bg-white text-gray-800 border-gray-200 hover:border-primary hover:shadow-md'; // Default available
            
            if (isOccupied) {
                bgClass = 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed opacity-60';
            } else if (isSelected) {
                bgClass = 'bg-primary text-white border-primary shadow-lg scale-105 ring-2 ring-offset-1 ring-primary';
            } else {
                // Available state
                bgClass = 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100 hover:scale-105';
            }
            
            div.className = `p-2 rounded-lg text-center text-xs font-bold cursor-pointer transition-all border ${bgClass} flex flex-col items-center justify-center`;
            
            let iconHtml = '';
            if (slot.is_bike) {
                iconHtml = '<i class="fas fa-motorcycle text-lg mb-1"></i>';
            } else {
                iconHtml = '<i class="fas fa-car text-lg mb-1"></i>';
            }

            div.innerHTML = `${iconHtml}<div class="font-bold">${slot.slot_number}</div>`;
            
            if (!isOccupied) {
                div.classList.add('relative');
                div.onclick = () => {
                    // Optimistic UI update + API call
                    if (selectedSlots.has(slot.slot_number)) {
                        // Unlock
                        selectedSlots.delete(slot.slot_number);
                        renderSlots(level);
                        fetch('/api/unlock_slot', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ area_id: currentAreaId, slot_number: slot.slot_number })
                        });
                    } else {
                        // Lock
                        if (selectedSlots.size < 5) { // Enforce max 5 spots
                            // Show loading state?
                            div.classList.add('animate-pulse');
                            
                            fetch('/api/lock_slot', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ area_id: currentAreaId, slot_number: slot.slot_number })
                            })
                            .then(res => {
                                if (res.status === 401) { window.location.href = '/login'; return; }
                                return res.json();
                            })
                            .then(data => {
                                div.classList.remove('animate-pulse');
                                if (data.status === 'success') {
                                    selectedSlots.add(slot.slot_number);
                                    renderSlots(level);
                                } else {
                                    alert(data.message || "Could not lock slot.");
                                    slot.status = 'Locked'; // Update local state
                                    renderSlots(level);
                                }
                            });
                        } else {
                            alert("You can select a maximum of 5 spots.");
                        }
                    }
                };
            } else if (slot.end_time) {
                div.innerHTML += `<div class="text-[10px] font-medium mt-1 text-red-900 bg-red-200/50 rounded px-1">Ends ${slot.end_time}</div>`;
            }
            grid.appendChild(div);
        });
    }
</script>
<style>
    .custom-div-icon {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .marker-pin {
        width: 30px;
        height: 30px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        position: absolute;
        border: 2px solid #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .custom-div-icon i {
        position: relative;
        z-index: 1;
        transform: rotate(45deg);
        margin-top: -15px;
        margin-left: -1px;
    }
</style>
{% endblock %}